<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSE Demo</title>
    <link rel="stylesheet" type="text/css" href="css/cryptography-demo.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="node_modules/jsencrypt/bin/jsencrypt.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>
<form onsubmit="encryptAndSubmit()" data-pay-encrypt-form>
    <fieldset>
        <label for="card-holder">Kaarthouder</label>
        <input id="card-holder" type="text" class="form-control" placeholder="Naam van de kaarthouder" name="cardholder" value="" data-pay-encrypt-field />
    </fieldset>

    <fieldset class="mt-3">
        <div class="row-pan-cvc-group">
            <div class="column-pan col-8">
                <div class="form-element-container has-icon-container">
                    <label for="cardnumber">Kaartnummer</label>
                    <div class="has-icon-wrap form-group">
                            <span class="input-container">
                                <input id="cardnumber" class="form-control" type="text" name="cardnumber" placeholder="Het nummer van uw credit- of debitkaart" value="" data-pay-encrypt-field />
                            </span>

                        <div class="icon-container">
                            <img src="img/creditcard/cc-front.svg" data-credit-card-type alt="Card type" />
                        </div>
                    </div>
                </div>
            </div>

            <div class="column-cvc col-4 ps-3">
                <div class="form-element-container form-group">
                    <label for="cvc" data-cvc-label>CVC</label>
                    <span class="input-container">
                            <input id="cvc" type="text" name="cardcvc" class="form-control" placeholder="123" value="" data-pay-encrypt-field />
                        </span>
                </div>
            </div>
        </div>

        <div class="row-expiry-group">
            <div class="column-month col-6 pe-2">
                <div class="form-element-container form-group">
                    <label for="month">Geldig tot maand</label>
                    <select name="valid_thru_month" class="form-control" id="month" data-pay-encrypt-field>
                        <option value="" disabled selected>Kies</option>
                        <option value="01">01 - Januari</option>
                        <option value="02">02 - Februari</option>
                        <option value="03">03 - Maart</option>
                        <option value="04">04 - April</option>
                        <option value="05">05 - Mei</option>
                        <option value="06">06 - Juni</option>
                        <option value="07">07 - Juli</option>
                        <option value="08">08 - Augustus</option>
                        <option value="09">09 - September</option>
                        <option value="10">10 - Oktober</option>
                        <option value="11">11 - November</option>
                        <option value="12">12 - December</option>
                    </select>
                </div>
            </div>
            <div class="column-year col-6 ps-2">
                <div class="form-element-container form-group">
                    <label for="year">Jaar</label>
                    <select name="valid_thru_year" id="year" class="form-control" data-pay-encrypt-field>
                        <option value="" disabled selected>Kies</option>
                        <option value="2021">2021</option>
                        <option value="2022">2022</option>
                        <option value="2023">2023</option>
                        <option value="2024">2024</option>
                        <option value="2025">2025</option>
                        <option value="2026">2026</option>
                        <option value="2027">2027</option>
                        <option value="2028">2028</option>>
                        <option value="2029">2029</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="form-element-container">
            <input type="submit" class="btn btn-primary" data-loading-state="0" />
        </div>
    </fieldset>
</form>

<!-- Modal -->
<div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-body" id="modalContent">
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">
    const myModal = new bootstrap.Modal(document.getElementById('exampleModal'));
    let encrypted = '';
    let transactionId = '';
    let entranceCode = '';
    let threedsTransactionId = '';
    let acquirerId = '';

    // 1. get public keys from pay
    let publicKey = '';
    let publicKeyIdentifier = '';
    fetch('api/public-keys.php')
        .then(response => response.json())
        .then(data => {
            publicKey = atob(data[0]['public_key']);
            publicKeyIdentifier = data[0]['identifier'];
        })
        .catch(error => console.error('Error fetching public keys:', error));

    function encryptAndSubmit() {
        event.preventDefault();

        const creditcardInfo = {
            browserJavaEnabled: navigator.javaEnabled(),
            browserJavascriptEnabled: true,
            browserLanguage: navigator.language,
            browserColorDepth: screen.colorDepth,
            browserScreenWidth: screen.width,
            browserScreenHeight: screen.height,
            browserTZ: new Date().getTimezoneOffset(),
            cardholder: document.querySelector('[name="cardholder"]').value,
            cardnumber: document.querySelector('[name="cardnumber"]').value,
            cardcvc: document.querySelector('[name="cardcvc"]').value,
            valid_thru_month: document.querySelector('[name="valid_thru_month"]').value,
            valid_thru_year: document.querySelector('[name="valid_thru_year"]').value,
        };

        var jsEncrypt = new JSEncrypt();
        jsEncrypt.setPublicKey(publicKey);
        encrypted = jsEncrypt.encrypt(JSON.stringify(creditcardInfo));

        fetch('api/authenticate.php', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: new URLSearchParams({
                identifier: publicKeyIdentifier,
                data: encrypted
            })
        })
            .then(response => response.json())
            .then(data => {
                console.log('Authorization response:', data);


                let html = `<html><head></head><body>${atob(data['challengeForm'])}<script type="text/javascript">(function(){ document.querySelector("form").submit() })();<\/script></body></html>`;
                document.getElementById('modalContent').innerHTML = '<iframe id="challenge-iframe" src="data:text/html;charset=utf-8,' +encodeURI(html) + '"></iframe>';

                myModal.show();

                acquirerId = data['acquirerID'];
                entranceCode = data['entranceCode'];
                threedsTransactionId = data['transactionID'];
                transactionId = data['transaction']['transactionId'];

                // Start polling
                poll(data['transactionID']);

            })
            .catch(error => console.error('Error during authorization:', error));
    }


    function poll(transactionId) {
        console.log('Polling transaction:', transactionId);
        const poller = setInterval(() => {
            fetch('api/transaction-status.php?transaction_id=' + transactionId)
                .then(response => response.json())
                .then(data => {
                    console.log('Poll response:', data);
                    if (data['transactionStatusCode'] === "100") {
                        console.log('Transaction completed');
                        myModal.hide();
                        finalizePayment();
                        clearInterval(poller);
                    }

                })
                .catch(error => console.error('Error during polling:', error));
        }, 2000);
    }

    function finalizePayment() {
        console.log('Finalizing payment');
        fetch('api/authorize.php', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: new URLSearchParams({
                identifier: publicKeyIdentifier,
                data: encrypted,
                transaction_id: transactionId,
                entrance_code: entranceCode,
                threeds_transaction_id: threedsTransactionId,
                acquirer_id: acquirerId,
            })
        })
            .then(response => response.json())
            .then(data => {
                console.log('Finalize payment response:', data);
            })
            .catch(error => console.error('Error during finalizing payment:', error));
    }
</script>

</body>
</html>
