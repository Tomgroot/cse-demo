<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSE Demo</title>
    <link href="https://cdn.openticket.tech/design/v0.9.43/ot.min.css" rel="stylesheet">
    <link href="https://whitelabel-config.openticket.local/style.css" rel="stylesheet">
    <script src="http://localhost:9999/node_modules/jsencrypt/bin/jsencrypt.js"></script>
    <style>
        .card-fields__number, .card-fields__expiration {
            display: flex;
            gap: 1rem;
        }
        /* TODO: replace and fix */
        .ot-document:not(.is-dark):not(.shadows) {
            background-color:white;
        }
    </style>
</head>
<body class="ot-document ot-content">
<form onsubmit="encryptAndSubmit()" data-pay-encrypt-form>
    <div class="card-fields">
        <div class="ot-input-field">
            <label class="ot-input-label"> Card holder name </label>
            <label class="ot-input-sublabel">Name as it appears on the card</label>
            <input type="text" placeholder="" name="cardholder">
        </div>
        <div class="ot-input-field">
            <label class="ot-input-label"> Card card number </label>
            <label class="ot-input-sublabel"></label>
            <div class="card-fields__number">
                <input type="text" name="cardnumber" maxlength="19" placeholder="xxxx xxxx xxxx xxxx">
                <div class="card-fields__number__cvc">
                    <input type="text" placeholder="CVC" maxlength="3" name="cardcvc">
                </div>
            </div>
        </div>
        <div class="ot-input-field">
            <label class="ot-input-label"> Expiration date </label>
            <label class="ot-input-sublabel"></label>
            <div class="card-fields__expiration">
                <select name="valid_thru_month" class="ot-select">
                    <option value="" disabled selected></option>
                    <option value="01">01 - Januari</option>
                    <option value="02">02 - Februari</option>
                    <option value="03">03 - Maart</option>
                    <option value="04">04 - April</option>
                    <option value="05">05 - Mei</option>
                    <option value="06">06 - Juni</option>
                    <option value="07">07 - Juli</option>
                    <option value="08">08 - Augustus</option>
                    <option value="09">09 - September</option>
                    <option value="10">10 - Oktober</option>
                    <option value="11">11 - November</option>
                    <option value="12">12 - December</option>
                </select>
                <select name="valid_thru_year" class="ot-select">
                    <option value="" disabled selected></option>
                    <option value="2021">2021</option>
                    <option value="2022">2022</option>
                    <option value="2023">2023</option>
                    <option value="2024">2024</option>
                    <option value="2025">2025</option>
                    <option value="2026">2026</option>
                    <option value="2027">2027</option>
                    <option value="2028">2028</option>
                    <option value="2029">2029</option>
                </select>
            </div>
        </div>
        <button class="ot-button is-fullwidth is-small" type="submit"> Submit <i class="oti oti-carrot-right is-small"></i></button>
    </div>
</form>

<script type="text/javascript">
    const jsEncrypt = new JSEncrypt();

    // Add spaces to card number for readability
    document.querySelector('input[name="cardnumber"]').addEventListener('input', function(e) {
        let value = e.target.value.replace(/\s+/g, '').replace(/(.{4})/g, '$1 ');
        e.target.value = value.trim();
    });

    window.addEventListener('message', (csePublicKey) => {
        console.log('Data received localhost:', csePublicKey, csePublicKey.data);

        if (!csePublicKey.data || !('public_key' in csePublicKey.data) || csePublicKey.data.public_key.length === 0) {
            return;
        }

        jsEncrypt.setPublicKey(atob(csePublicKey.data.public_key));
    });

    function encryptAndSubmit() {
        event.preventDefault();

        const dataToEncrypt = {
            browserJavaEnabled: navigator.javaEnabled(),
            browserJavascriptEnabled: true,
            browserLanguage: navigator.language,
            browserColorDepth: screen.colorDepth,
            browserScreenWidth: screen.width,
            browserScreenHeight: screen.height,
            browserTZ: new Date().getTimezoneOffset(),
            cardholder: document.querySelector('[name="cardholder"]').value,
            cardnumber: document.querySelector('[name="cardnumber"]').value,
            cardcvc: document.querySelector('[name="cardcvc"]').value,
            valid_thru_month: document.querySelector('[name="valid_thru_month"]').value,
            valid_thru_year: document.querySelector('[name="valid_thru_year"]').value,
        };

        const encrypted = jsEncrypt.encrypt(JSON.stringify(dataToEncrypt));

        window.parent.postMessage({encrypted}, '*');
    }
</script>

</body>
</html>
